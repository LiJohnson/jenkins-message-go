<!DOCTYPE html>
<html lang="en">
  <head>
    <title>build log</title>
    <script type="text/javascript">
      let $ = (s) => document.querySelector(s);
      function appendLog(item) {
        $("#log").prepend(item);
      }
      let retry = 0;
      let loadRecentLogs = true
      let connect = () => {
        retry++;
        $("#status").innerHTML = "🌦";
        let conn = new WebSocket(
          location.protocol.replace("http", "ws") + "//" + location.host + "/ws"
        );
        conn.onclose = (evt) => {
          $("#status").innerHTML = "🌧";
          if (retry < 5) {
            setTimeout(connect, 3000 * retry);
          }
        };
        conn.onmessage = (evt) => {
          let item = document.createElement("div");
          item.innerHTML = evt.data;
          item.querySelectorAll("blockquote").forEach((n) => {
            item.removeChild(n);
          });
          item.querySelectorAll("a").forEach((a) => {
            a.target = "_blank";
          });

          appendLog(item);
        };
        conn.onopen = () => {
          $("#status").innerHTML = "☀️";
          retry = 1;
          loadRecentLogs && conn.send("recentLogs");
          loadRecentLogs = false
        };
      };
      window.onload = () => {
        if (window["WebSocket"]) {
          connect();
        } else {
          var item = document.createElement("div");
          item.innerHTML = "<b>Your browser does not support </b>";
          appendLog(item);
        }
      };
    </script>
    <style type="text/css">
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        padding: 5px;
        margin: 0;
        width: 100%;
        height: 100%;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
        font-family: Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB,
          Microsoft YaHei, Arial, sans-serif;
      }

      #log {
        margin: 10px;
      }
      #log > pre,
      #log > div {
        border-bottom: 1px solid #dfdfdf;
      }
      #log h2 {
        font-size: 1.25rem;
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-weight: 500;
        line-height: 1.2;
      }
      #log p {
        margin-bottom: 0.1rem;
      }
      a {
        color: #0d6efd;
        text-decoration: underline;
      }
      a:hover {
        color: #0a58ca;
      }

      a:not([href]):not([class]),
      a:not([href]):not([class]):hover {
        color: inherit;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="bar">
      <span id="status"></span>
    </div>
    <div id="log"></div>
  </body>
</html>
